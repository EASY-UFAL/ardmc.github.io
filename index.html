<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DMC AR project</title>




  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="style.css">


</head>
<body>
  <div class="container">
    <video class="input_video" style="display: none; position: relative;"></video>  
    <canvas class="output_canvas"></canvas>
  </div>


  <table style="width: 100%; height: 350px;">

    <tr>
      <td> <button class="button-ar" role="button" id='b1'> B 1 </button></td>
      <td> <button class="button-ar" id='b2'> B 2 </button></td>
    </tr>


    <tr>
      <td> <button class="button-ar" id='b3'> B 3 </button></td>
      <td> <button class="button-ar" id='b4'> B 4 </button></td>
    </tr>

  </table>
  <!-- altere o valor de output_canvas -->
  <script src="script.js"></script>


</body>


<!-- <script type="module"> -->
<script type="text/javascript">

var HAND;  

var STATE = 'depressed';

const b1 = document.getElementById('b1');
const b2 = document.getElementById('b2');
const b3 = document.getElementById('b3');
const b4 = document.getElementById('b4');


const videoElement = document.getElementsByClassName('input_video')[0];
const canvasElement = document.getElementsByClassName('output_canvas')[0];
const canvasCtx = canvasElement.getContext('2d');

canvasElement.width = window.screen.width*window.devicePixelRatio;
canvasElement.height = window.screen.height*window.devicePixelRatio;

function clearButtons() {
  b1.style.borderColor = 'gray';
  b2.style.borderColor = 'gray';
  b3.style.borderColor = 'gray';
  b4.style.borderColor = 'gray';
}

function onResults(results) {
  canvasCtx.save();
  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
  
  //canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

  clearButtons();


  if (results.multiHandLandmarks.length>0) {
    HAND = results.multiHandLandmarks;

    for (let i = 0; i<HAND[0].length; i++) {
  
      let landmarks = HAND[0][i];



      indexFinger = HAND[0][8];
      middleFinger = HAND[0][12];

      // Calcular a distância entre os dedos
      const distance = Math.sqrt(
          Math.pow(middleFinger.x - indexFinger.x, 2) +
          Math.pow(middleFinger.y - indexFinger.y, 2) +
          Math.pow(middleFinger.z - indexFinger.z, 2)
      );

      // Verificar se os dedos estão colados
      const areFingersClose = distance < 0.07; // Ajuste o limite de acordo com suas necessidades
      console.log(indexFinger, middleFinger, distance)

      console.log(`Os dedos indicador e médio estão colados: ${areFingersClose}`);

      let x = landmarks.x*canvasElement.width;
      let y = landmarks.y*canvasElement.height;
      let z = Math.abs(landmarks.z);

      // console.log("x : "+ x, "y : "+y, "z : "+z);

      var color = '#000';

      if (i==8) color = '#f00';

      
      if ((i==8) && z>0.1) {
        color = '#0f0';
        let elem = document.elementFromPoint(x, y);
        if (elem != null) {
          elem.style.borderColor = 'red';
          
          if (STATE == 'depressed') {
            click(elem);
            STATE = 'pressed';
          }
        }
      } 
      if(STATE == 'pressed' && (i==12)){
        color = 'blue'
        if(areFingersClose){
          alert('Você pressionou um botão!')
        }
      }
      if ( (i==8) && (z<0.1) ) STATE = 'depressed';

      canvasCtx.beginPath();
      canvasCtx.arc(x, y, 100*z, 0, 2 * Math.PI);
      canvasCtx.fillStyle = color;
      canvasCtx.fill();
      canvasCtx.stroke();
    }
  }
  canvasCtx.restore();
}



const hands = new Hands({locateFile: (file) => {
  return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
}});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});
hands.onResults(onResults);




const camera = new Camera(videoElement, {
  onFrame: async () => {
    await hands.send({image: videoElement});
  },
  width: 640,
  height: 340
});
camera.start();





function click(bt) {
  console.log(bt.id);

  var b = '0';
  if (bt.id == 'b2')
    b = '1';



    fetch('https://192.168.0.59/'+b, {
      method: 'GET',
      headers: {
          'Accept': 'application/html',
          'Access-Control-Allow-Origin': '*'
      },
  })
    .then(response => response.json())
    .then(response => console.log(JSON.stringify(response)))


}

</script>
</html>